<!DOCTYPE html>
<html>
  <head>
    <title>preliminaries</title>
    <meta charset="utf-8">
    <meta name="generator" content="knitr" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/7.3/styles/github.min.css">

<style type="text/css">
/* Derived from the Docco package by Jeremy Ashkenas: https://github.com/jashkenas/docco/ */
body {
    font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif;
    height:100%;
    font-size: 16px;
    line-height: 24px;
    color: #30404f;
    margin: 0;
    padding: 0;
}

h1, h2, h3, h4, h5, h6 {
    color: #112233;
    line-height: 1em;
    font-weight: normal;
    margin: 0 0 15px 0;
}

p {
    margin: 0 0 15px 0;
    font-size:17px;
}

#footer p{
    margin:0;
    font-size:12px;
    text-align: center;
}

a{
    color:#0088cc;
    text-decoration:none;
}

a:hover,a:focus{
    color:#005580;
    text-decoration:underline;
}

#container {
    position: relative;
    margin: 0;
    height:100%;
}

body > #container { height: auto; min-height: 100%; }

table{
    width:100%;
    border: 0;
    outline: 0;
}

td.docs{
    width: 50%;
    text-align: left;
    vertical-align: top;
    padding: 10px 25px 1px 50px;
}


td.code{
    background: #f5f5ff;
    padding: 10px 25px 1px 50px;
    overflow-x: hidden;
    vertical-align: top;
}

code{
    font-size:12px;
    margin: 0;
    padding: 0;
}

td.docs code{
    background: #f8f8ff;
    border: 1px solid #dedede;
    font-size: 80%;
    padding: 0 0.2em;
}

td.docs img{
  max-width: 100%;
}

pre code{
    padding:2px 4px;
    background:#f5f5ff;
}

td.code pre code{
    line-height: 18px;
}

.pilwrap {
    position: relative;
}
.pilcrow {
    font: 12px Arial;
    text-decoration: none;
    color: rgb(69, 69, 69);
    position: absolute;
    top: 3px;
    left: -20px;
    padding: 1px 2px;
    opacity: 0;
}

td.docs:hover .pilcrow {
    opacity: 1;
}

blockquote {
    border-left: 4px solid #DDD;
    padding: 0 15px;
    color: #777;
}
div.handler{
      width: 5px;
      padding: 0;
      cursor: col-resize;
      position: absolute;
      z-index: 5;
}
</style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/7.3/highlight.min.js"></script>
<script type="text/javascript">
hljs.LANGUAGES.r=function(a){var b="([a-zA-Z]|\\.[a-zA-Z.])[a-zA-Z0-9._]*";return{c:[a.HCM,{b:b,l:b,k:{keyword:"function if in break next repeat else for return switch while try tryCatch|10 stop warning require library attach detach source setMethod setGeneric setGroupGeneric setClass ...|10",literal:"NULL NA TRUE FALSE T F Inf NaN NA_integer_|10 NA_real_|10 NA_character_|10 NA_complex_|10"},r:0},{cN:"number",b:"0[xX][0-9a-fA-F]+[Li]?\\b",r:0},{cN:"number",b:"\\d+(?:[eE][+\\-]?\\d*)?L\\b",r:0},{cN:"number",b:"\\d+\\.(?!\\d)(?:i\\b)?",r:0},{cN:"number",b:"\\d+(?:\\.\\d*)?(?:[eE][+\\-]?\\d*)?i?\\b",r:0},{cN:"number",b:"\\.\\d+(?:[eE][+\\-]?\\d*)?i?\\b",r:0},{b:"`",e:"`",r:0},{cN:"string",b:'"',e:'"',c:[a.BE],r:0},{cN:"string",b:"'",e:"'",c:[a.BE],r:0}]}}(hljs);
</script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="http://yihui.name/media/js/center-images.js"></script>
  </head>
  <body>
    <div id="container">
      <table><!--table start-->
<tr id="row1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#row1">&para;</a></div><h1>preliminaries</h1>

</td><td class="code"></td></tr><tr id="row2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#row2">&para;</a></div><p>Load some basic dependencies</p></td><td class="code"><pre><code class="r">library(caret)
library(DAMisc)
library(splines)
library(caretEnsemble)
library(foreign)
library(sna)
library(network)
library(psych)
library(doSNOW)
library(parallel)
</code></pre></td></tr><tr id="row3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#row3">&para;</a></div>

<h2>Optional</h2>

</td><td class="code"></td></tr><tr id="row4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#row4">&para;</a></div><p>install kaggleNCAA</p></td><td class="code"><pre><code class="r">require(&#39;devtools&#39;)
install_github(&#39;zachmayer/kaggleNCAA&#39;)
require(kaggleNCAA)
</code></pre></td></tr><tr id="row5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#row5">&para;</a></div>

<p>to get a phone notification when you run this via boxcar, install tmisc and insert the appropriate .boxcar_token</p></td><td class="code"><pre><code class="r"> require(devtools)
 install_github(&#39;trcook/tmisc&#39;,subdir=&#39;tmisc&#39;)
 .boxcar_token&lt;-c(&quot;TOKEN_HERE&quot;)
 library(tmisc)
</code></pre></td></tr><tr id="row6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#row6">&para;</a></div>

<p>N threads, set to 0 to turn off parallel processing. Otherwise, set to appropriate number of cores.</p></td><td class="code"><pre><code class="r">ncluster&lt;-4
</code></pre></td></tr><tr id="row7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#row7">&para;</a></div>

<p>set your directory here:</p></td><td class="code"><pre><code class="r">setwd(&quot;C:/Users/Thomas/Desktop/NCAA/&quot;)
</code></pre></td></tr><tr id="row8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#row8">&para;</a></div>

<h1>START TRAINING</h1>

</td><td class="code"></td></tr><tr id="row9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#row9">&para;</a></div><p>This is the training process
First we boot up in parallel</p></td><td class="code"><pre><code class="r">ivalidate&lt;-read.csv(&quot;./ivalidate_pt1.csv&quot;)
start&lt;-Sys.time()
if(ncluster&gt;0){
cl&lt;-makeCluster(ncluster)
registerDoSNOW(cl)
}
</code></pre></td></tr><tr id="row10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#row10">&para;</a></div>

<p>Set some parameters to the training process</p></td><td class="code"><pre><code class="r">my_control &lt;- trainControl(
  method=&#39;repeatedcv&#39;,
  repeats=5,
  savePredictions=TRUE,
  classProbs=TRUE,
  summaryFunction=twoClassSummary
)
</code></pre></td></tr><tr id="row11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#row11">&para;</a></div>

<p>Run models &ndash; this part takes a while. Specific models we use are listed in the method-list parameter</p></td><td class="code"><pre><code class="r">models &lt;- caretList(
  win~., data=ivalidate[,grepl(&quot;win|survscores|powscore|rank|winper|rpi|sos|ncf|orank&quot;, names(ivalidate))],
  trControl=my_control,
  methodList=c(&#39;bagFDA&#39;, &#39;nnet&#39;, &#39;ada&#39;, &#39;bayesglm&#39;, &#39;svmPoly&#39;, &#39;rf&#39;, &#39;knn&#39;, &#39;svmLinear&#39;, &#39;gbm&#39;)#&#39;knn&#39;, , &#39;qrnn&#39;, &#39;svmPoly&#39;, &#39;AdaBag&#39;
)
</code></pre></td></tr><tr id="row12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#row12">&para;</a></div>

<p>This will stack the models into an ensemble using a greedy stepwise algorithm</p></td><td class="code"><pre><code class="r">stack &lt;- caretStack(models, method=&#39;glm&#39;)
greedy &lt;- caretEnsemble(models, iter=1000L)
</code></pre></td></tr><tr id="row13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#row13">&para;</a></div>

<p>Turn off parallel processing</p></td><td class="code"><pre><code class="r">if(ncluster&gt;0){
stopCluster(cl)
}
</code></pre></td></tr><tr id="row14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#row14">&para;</a></div>

<p>Send a handy notification to your phone. The body will have the time it took to process:</p></td><td class="code"><pre><code class="r">end&lt;-Sys.time()
boxcar_notify(token = .boxcar_token,body = paste(&quot;time taken:&quot;,c(start-end)),title = &quot;Training Done&quot;)
</code></pre></td></tr><tr id="row15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#row15">&para;</a></div>

<h1>Validation Process</h1>

</td><td class="code"></td></tr><tr id="row16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#row16">&para;</a></div><p>Load in our validation dataset</p></td><td class="code"><pre><code class="r">ivalidate&lt;-read.csv(&quot;./ivalidate_pt2.csv&quot;)
</code></pre></td></tr><tr id="row17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#row17">&para;</a></div>

<p>Make the predictions and get the log loss for the validation set. </p></td><td class="code"><pre><code class="r">preds &lt;- predict(stack, type=&quot;prob&quot;, newdata = ivalidate[ ,grepl(&quot;win|survscores|powscore|rank|winper|rpi|sos|ncf|orank&quot;, names(ivalidate))])[,1]
df &lt;- data.frame(preds=preds[which(ivalidate$daynum&gt;135)], realscore=ivalidate$scorediff[which(ivalidate$daynum&gt;135)], season=ivalidate$season[which(ivalidate$daynum&gt;135)])
qplot(preds, realscore, data=df, xlab=&quot;Prediction&quot;, ylab=&quot;Real Margin&quot;) + geom_smooth(method=&quot;loess&quot;)
df$win &lt;- 1*(df$realscore&gt;0)
df$pwin &lt;- 1*(df$preds&gt;=.5)
logloss &lt;- sum((df$win*log(df$preds) + (1-df$win)*log(1-df$preds))  * (1/nrow(df)) ); logloss
accuracy &lt;- sum(df$win==df$pwin)/nrow(df) #Make 65% accuracy
</code></pre></td></tr><tr id="row18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#row18">&para;</a></div>

<p>Calculate Log Loss &ndash; this is the metric by which the contest is judged.</p></td><td class="code"><pre><code class="r">CappedBinomialDeviance &lt;- function(a, p) {
  if (length(a) !=  length(p)) stop(&quot;Actual and Predicted need to be equal lengths!&quot;)
  p_capped &lt;- pmin(0.99, p)
  p_capped &lt;- pmax(0.01, p_capped)
  -sum(a * log(p_capped) + (1 - a) * log(1 - p_capped)) / length(a)
}
CappedBinomialDeviance(df$win, df$preds)
</code></pre></td></tr><tr id="row19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#row19">&para;</a></div>

<h1>Second Round Training</h1>

</td><td class="code"></td></tr><tr id="row20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#row20">&para;</a></div><p>get final data</p></td><td class="code"><pre><code class="r">ivalidate&lt;-read.csv(&quot;./ivalidate_pt3.csv&quot;)
</code></pre></td></tr><tr id="row21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#row21">&para;</a></div>

<p>Start up parallel processing </p></td><td class="code"><pre><code class="r">start&lt;-Sys.time()
if(ncluster&gt;0){
cl&lt;-makeCluster(ncluster)
registerDoSNOW(cl)
}
</code></pre></td></tr><tr id="row22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#row22">&para;</a></div>

<p>set parameters for  models:</p></td><td class="code"><pre><code class="r">my_control &lt;- trainControl(
  method=&#39;repeatedcv&#39;,
  repeats=5,
  savePredictions=TRUE,
  classProbs=TRUE,
  summaryFunction=twoClassSummary
)
</code></pre></td></tr><tr id="row23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#row23">&para;</a></div>

<p>run models</p></td><td class="code"><pre><code class="r">models &lt;- caretList(
  win~., data=ivalidate[,grepl(&quot;win|survscores|powscore|rank|winper|rpi|sos|ncf&quot;, names(ivalidate))],
  trControl=my_control,
  methodList=c(&#39;bagFDA&#39;, &#39;nnet&#39;, &#39;ada&#39;, &#39;bayesglm&#39;, &#39;svmPoly&#39;, &#39;rf&#39;, &#39;knn&#39;, &#39;svmLinear&#39;, &#39;gbm&#39;)#&#39;knn&#39;, , &#39;qrnn&#39;, &#39;svmPoly&#39;, &#39;AdaBag&#39;
)
</code></pre></td></tr><tr id="row24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#row24">&para;</a></div>

<p>This will stack the models into an ensemble using a greedy stepwise algorithm</p></td><td class="code"><pre><code class="r">stack &lt;- caretStack(models, method=&#39;glm&#39;)
greedy &lt;- caretEnsemble(models, iter=1000L)
</code></pre></td></tr><tr id="row25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#row25">&para;</a></div>

<p>turn off parallel processing:</p></td><td class="code"><pre><code class="r">if(ncluster&gt;0){
stopCluster(cl)
}
</code></pre></td></tr><tr id="row26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#row26">&para;</a></div>

<p>send notification to phone:</p></td><td class="code"><pre><code class="r">end&lt;-Sys.time()
boxcar_notify(token = .boxcar_token,body = paste(&quot;time taken:&quot;,c(start-end)),title = &quot;Final Training Done&quot;)
</code></pre></td></tr><tr id="row27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#row27">&para;</a></div>

<h1>Final Round Predictions:</h1>

</td><td class="code"></td></tr><tr id="row28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#row28">&para;</a></div><p>Get final round data:</p></td><td class="code"><pre><code class="r">ivalidate&lt;-read.csv(&quot;./ivalidate_pt4.csv&quot;)
df2&lt;-read.csv(&quot;./df2.csv&quot;)
df&lt;-read.csv(&quot;./df.csv&quot;)
</code></pre></td></tr><tr id="row29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#row29">&para;</a></div>

<p>CREATE PREDICTIONS FOR EVERY MATCH-UP FOR STAGE 2</p></td><td class="code"><pre><code class="r">preds &lt;- predict(stack, type=&quot;prob&quot;, newdata = df2[,grepl(&quot;win|survscores|powscore|rank|winper|rpi|sos|ncf|orank&quot;, names(df2))])[,2]
</code></pre></td></tr><tr id="row30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#row30">&para;</a></div>

<p>put in data.frame</p></td><td class="code"><pre><code class="r">finaldf &lt;- data.frame(id=df$id, pred=1-preds)
write.csv(finaldf, &quot;./stage2_n2.csv&quot;, row.names=F)
</code></pre></td></tr><tr id="row31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#row31">&para;</a></div>

<p>generate a comparision of predictions against seed-based predictions:</p></td><td class="code"><pre><code class="r">d1 &lt;- read.csv(&quot;./kaggle_submission_public.csv&quot;)
d2 &lt;- read.csv(&quot;./stage2_n2.csv&quot;); names(d2)[2] &lt;- &quot;mypred&quot;
dat &lt;- merge(d1, d2, by=&quot;id&quot;)
qplot(mypred, pred, data=dat)
</code></pre></td></tr><tr id="row32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#row32">&para;</a></div>

<h1>Generate bracket</h1>

</td><td class="code"></td></tr><tr id="row33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#row33">&para;</a></div><p>From the kaggleNCAA package (install with install_github(&#39;zachmayer/kaggleNCAA&#39;))</p></td><td class="code"><pre><code class="r">dat&lt;-parseBracket(&quot;./stage2_n2.csv&quot;)
setnames(dat,names(dat),c(&quot;season&quot;, &quot;team_2&quot;, &quot;team_1&quot;, &quot;pred&quot;))
bracket &lt;- walkTourney(dat, year=2015)
printableBracket(bracket)
</code></pre></td></tr><tr id="row34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#row34">&para;</a></div>
</td><td class="code"></td></tr>
      </table><!--table end-->
    </div>
  <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script src="http://yihui.name/knitr/js/docco-resize.js"></script>
  </body>
</html>
